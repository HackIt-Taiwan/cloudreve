services:
  cloudreve:
    build:
      context: .
      dockerfile: Dockerfile.coolify
    depends_on:
      - redis
    restart: unless-stopped
    ports:
      - 5212:5212
      - 6888:6888
      - 6888:6888/udp
    environment:
      - CR_CONF_Database.Type=postgres
      # Force Cloudreve to listen on container network (avoid binding 127.0.0.1 which causes reverse-proxy 502).
      - CR_CONF_System.Listen=:5212
      # Use an external Postgres database (Coolify DB resource or managed DB).
      # Example (no TLS): postgres://cloudreve:password@host:5432/cloudreve?sslmode=disable
      # Example (custom CA): postgres://cloudreve:password@host:5432/cloudreve?sslmode=verify-full&sslrootcert=/certs/ca-certificate.crt
      # NOTE: Avoid `ssl=true` (lib/pq treats it as a server param and Postgres rejects it); use `sslmode=` instead.
      - CR_CONF_Database.DatabaseURL=${CR_DATABASE_URL:-}
      - CR_CONF_Redis.Server=redis:6379
      # Important for Passport redirect_uri (first install only): set this to your public URL, e.g. https://drive.hackit.one
      - CR_SETTING_DEFAULT_siteURL=${CR_SITE_URL:-https://drive.hackit.one}
      - PASSPORT_API_BASE_URL=${PASSPORT_API_BASE_URL:-}
      - PASSPORT_API_TOKEN=${PASSPORT_API_TOKEN:-}
      - PASSPORT_CLIENT_ID=${PASSPORT_CLIENT_ID:-}
      - PASSPORT_SSO_ONLY=${PASSPORT_SSO_ONLY:-true}
    volumes:
      - backend_data:/cloudreve/data
      - /opt/do/certs/ca-certificate.crt:/certs/ca-certificate.crt:ro

  redis:
    image: redis:latest
    restart: unless-stopped
    volumes:
      - redis_data:/data

volumes:
  backend_data:
  redis_data:
